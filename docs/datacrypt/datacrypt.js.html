<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: datacrypt.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: datacrypt.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
var crypto = require('crypto');
var algorithm = 'aes-256-ctr'; //The encryption algorithm
var datalayer;


function encrypt(text,secret,cb){
	var cipher = crypto.createCipher(algorithm,secret)
	var crypted;
	try {
		crypted = cipher.update(text,'utf8','hex')
		crypted += cipher.final('hex');
		cb(true,{'secret':crypted});
	}
	catch(err) {
		cb(false,err);
	}
}

function decrypt(text,secret,cb){
	var dec;
	var decipher = crypto.createDecipher(algorithm,secret)
	try {
		dec = decipher.update(text,'hex','utf8')
		dec += decipher.final('utf8');
		cb(true,{'secret':dec});
	}
	catch(err) {
		cb(false,err);
	}
}


/**
 * Decrypts some information using the user Secret Key
 * @param	{string}   userid User ID
 * @param  {string}   text   The text to be decrypted
 * @param  {Function} cb     Callback Function
 */
exports.decryptForUser = function(userid,text,cb) {
	datalayer.getAllSecrets(function processSecrets(result,content){
		if(result) {
			var isInside=false;
			for (var i=0;i&lt;content.length;i++) {
				var currentSecret=content[i];
				if (currentSecret['id']===userid &amp;&amp; currentSecret['secret']!==null) {
					isInside=true;
					decrypt(text,currentSecret['secret'],cb);
					break;
				}
			}
			if (isInside===false)
				cb(true,{'noSecret':null});
		}
		else {
			cb(false,"Internal Server Error");
		}
	});
}


/**
 * Encrypts some information using the user Secret Key
 * @param  {string}   userid User ID
 * @param  {string}   text   The text to be encrypted
 * @param  {Function} cb     Callback Function
 */
exports.encryptForUser = function(userid,text,cb) {
	datalayer.getAllSecrets(function processSecrets(result,content){
		if(result) {
			var isInside=false;
			for (var i=0;i&lt;content.length;i++) {
				var currentSecret=content[i];
				if (currentSecret['id']===userid &amp;&amp; currentSecret['secret']!==null) {
					isInside=true;
					encrypt(text,currentSecret['secret'],cb);
					break;
				}
			}
			if (isInside===false)
				cb(true,{'noSecret':null});
		}
		else {
			cb(false,"Internal Server Error");
		}
	});
}

/**
 * Module used to encrypt and decrypt information using the secret key
 * of the users. It uses the aes-256-ctr algorithm.
 * @param  {datalayer} dblayer The datalayer module
 * @return {datacrypt}         This module itself
 */
function datacrypt(dblayer) {
	datalayer=dblayer;
	return exports;
}
module.exports = datacrypt
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#datacrypt">datacrypt</a></li><li><a href="global.html#decryptForUser">decryptForUser</a></li><li><a href="global.html#encryptForUser">encryptForUser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0</a> on Tue May 12 2015 13:55:52 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
